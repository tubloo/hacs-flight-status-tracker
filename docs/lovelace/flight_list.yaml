type: vertical-stack
cards:
  - type: custom:mushroom-title-card
    title: Flight List

  - type: custom:auto-entities
    card:
      type: vertical-stack
    card_param: cards
    filter:
      template: >
        {% set flights = state_attr('sensor.flight_status_tracker_upcoming_flights','flights') or [] %}
        {% set flights = flights | sort(attribute='dep.scheduled') %}
        [
        {%- for f in flights -%}
          {%- set date_fmt = '%d %b (%a)' -%}

          {%- set dep = f.dep or {} -%}
          {%- set arr = f.arr or {} -%}
          {%- set dep_air = dep.airport or {} -%}
          {%- set arr_air = arr.airport or {} -%}

          {%- set dep_code = (dep_air.iata or '-') | upper -%}
          {%- set arr_code = (arr_air.iata or '-') | upper -%}

          {%- set dep_label_raw = dep_air.city or dep_air.name or dep_code -%}
          {%- set arr_label_raw = arr_air.city or arr_air.name or arr_code -%}
          {%- set dep_label = dep_label_raw | title -%}
          {%- set arr_label = arr_label_raw | title -%}

          {%- set dep_sched_dt = dep.scheduled_local and as_datetime(dep.scheduled_local) -%}
          {%- set dep_est_dt = dep.estimated_local and as_datetime(dep.estimated_local) -%}
          {%- set dep_act_dt = dep.actual_local and as_datetime(dep.actual_local) -%}

          {%- set arr_sched_dt = arr.scheduled_local and as_datetime(arr.scheduled_local) -%}
          {%- set arr_est_dt = arr.estimated_local and as_datetime(arr.estimated_local) -%}
          {%- set arr_act_dt = arr.actual_local and as_datetime(arr.actual_local) -%}

          {%- set dep_sched = dep_sched_dt and dep_sched_dt.strftime('%H:%M') -%}
          {%- set dep_est = dep_est_dt and dep_est_dt.strftime('%H:%M') -%}
          {%- set dep_act = dep_act_dt and dep_act_dt.strftime('%H:%M') -%}

          {%- set arr_sched = arr_sched_dt and arr_sched_dt.strftime('%H:%M') -%}
          {%- set arr_est = arr_est_dt and arr_est_dt.strftime('%H:%M') -%}
          {%- set arr_act = arr_act_dt and arr_act_dt.strftime('%H:%M') -%}

          {%- set dep_tz = dep_air.tz_short or '' -%}
          {%- set arr_tz = arr_air.tz_short or '' -%}
          {%- set viewer_tz = now().strftime('%Z') -%}

          {%- set dep_est_or_act = dep_act or dep_est -%}
          {%- set arr_est_or_act = arr_act or arr_est -%}

          {%- set dep_changed = dep_est_or_act and dep_sched and dep_est_or_act != dep_sched -%}
          {%- set arr_changed = arr_est_or_act and arr_sched and arr_est_or_act != arr_sched -%}

          {%- set raw_state = (f.get('status_state') or 'unknown') | lower -%}
          {%- set dep_state_dt = dep.scheduled and as_datetime(dep.scheduled) -%}

          {%- if raw_state in ['active','en route','en-route','enroute'] -%}
            {%- set state = 'En Route' -%}
          {%- elif raw_state == 'arrived' -%}
            {%- set state = 'Arrived' -%}
          {%- elif raw_state == 'cancelled' -%}
            {%- set state = 'Cancelled' -%}
          {%- elif raw_state == 'diverted' -%}
            {%- set state = 'Diverted' -%}
          {%- elif raw_state == 'unknown' -%}
            {%- set state = 'Unknown' -%}
          {%- else -%}
            {%- set state = raw_state | title -%}
          {%- endif -%}

          {%- set route_state = 'Scheduled' if raw_state == 'unknown' else state -%}

          {%- set delay = f.get('delay_status_key') or ((f.get('delay_status') or 'unknown') | lower | replace(' ', '_')) -%}
          {%- set is_delayed = delay == 'delayed' -%}
          {%- set is_on_time = delay in ['on_time','early'] -%}

          {%- set within_6h = dep_state_dt and (as_timestamp(dep_state_dt) - as_timestamp(now()) <= 6*3600) and (as_timestamp(dep_state_dt) - as_timestamp(now()) > 0) -%}

          {%- set badge = 'bg-gray-600 text-white' -%}
          {%- set route_color = 'text-gray-400' -%}
          {%- set time_color = 'text-gray-300' -%}

          {%- if state in ['Cancelled','Diverted'] or is_delayed -%}
            {%- set badge = 'bg-red-800 text-white' -%}
            {%- set route_color = 'text-red-700' -%}
            {%- set time_color = 'text-red-600' -%}
          {%- elif state == 'En Route' -%}
            {%- set badge = 'bg-emerald-800 text-white' -%}
            {%- set route_color = 'text-emerald-700' -%}
            {%- set time_color = 'text-emerald-600' -%}
          {%- elif state == 'Arrived' and is_on_time -%}
            {%- set badge = 'bg-emerald-800 text-white' -%}
            {%- set route_color = 'text-emerald-700' -%}
            {%- set time_color = 'text-emerald-600' -%}
          {%- elif state == 'Arrived' and is_delayed -%}
            {%- set badge = 'bg-red-800 text-white' -%}
            {%- set route_color = 'text-red-700' -%}
            {%- set time_color = 'text-red-600' -%}
          {%- elif state == 'Scheduled' and is_on_time and within_6h -%}
            {%- set badge = 'bg-emerald-800 text-white' -%}
            {%- set route_color = 'text-emerald-700' -%}
            {%- set time_color = 'text-emerald-600' -%}
          {%- endif -%}

          {%- set route_bg = route_color | replace('text-','bg-') -%}

          {%- set dep_date = dep_sched_dt and dep_sched_dt.strftime(date_fmt) or '-' -%}
          {%- set arr_date = arr_sched_dt and arr_sched_dt.strftime(date_fmt) or '-' -%}
          {%- set pax = (f.travellers | join(', ')) if f.travellers else '' -%}

          {%- set dep_time = dep.actual or dep.estimated or dep.scheduled -%}
          {%- set arr_time = arr.actual or arr.estimated or arr.scheduled -%}
          {%- set dep_dt = dep_time and as_datetime(dep_time) -%}
          {%- set arr_dt = arr_time and as_datetime(arr_time) -%}

          {%- set dep_viewer_dt = dep_time and (as_datetime(dep_time) | as_local) -%}
          {%- set arr_viewer_dt = arr_time and (as_datetime(arr_time) | as_local) -%}
          {%- set dep_viewer = dep_viewer_dt and dep_viewer_dt.strftime('%H:%M') -%}
          {%- set arr_viewer = arr_viewer_dt and arr_viewer_dt.strftime('%H:%M') -%}
          {%- set show_dep_viewer = dep_viewer and (dep_tz != viewer_tz) and (dep_viewer != (dep_est_or_act or dep_sched)) -%}
          {%- set show_arr_viewer = arr_viewer and (arr_tz != viewer_tz) and (arr_viewer != (arr_est_or_act or arr_sched)) -%}
          {%- set show_viewer_row = not (dep_tz == viewer_tz and arr_tz == viewer_tz) -%}

          {%- set show_strike_row = dep_changed or arr_changed -%}

          {%- set dep_term = dep.terminal or '' -%}
          {%- set dep_gate = dep.gate or '' -%}
          {%- set arr_term = arr.terminal or '' -%}
          {%- set arr_gate = arr.gate or '' -%}

          {%- set dep_term_gate = (("Terminal " ~ dep_term) if dep_term else "") ~ ((" - Gate " ~ dep_gate) if dep_gate else "") -%}
          {%- set arr_term_gate = (("Terminal " ~ arr_term) if arr_term else "") ~ ((" - Gate " ~ arr_gate) if arr_gate else "") -%}
          {%- set show_term_gate_row = (dep_term_gate | trim) or (arr_term_gate | trim) -%}

          {%- set pos = f.position if f.position is defined else {} -%}
          {%- set pos_ts = pos.timestamp if pos.timestamp is defined else None -%}
          {%- set now_dt = pos_ts and as_datetime(pos_ts) or now() -%}

          {%- set total = (arr_dt and dep_dt) and (as_timestamp(arr_dt) - as_timestamp(dep_dt)) -%}
          {%- set elapsed = (arr_dt and dep_dt) and (as_timestamp(now_dt) - as_timestamp(dep_dt)) -%}
          {%- set pct = (total and elapsed) and (elapsed / total * 100) or 0 -%}
          {%- if pct < 0 %}{% set pct = 0 %}{% endif -%}
          {%- if pct > 100 %}{% set pct = 100 %}{% endif -%}

          {%- set in_flight = route_state == 'En Route' -%}

          {%- if in_flight -%}
            {%- set pct_gap = 6 if pct < 6 else (94 if pct > 94 else pct) -%}
            {%- set plane_x = pct_gap -%}
          {%- elif route_state == 'Arrived' -%}
            {%- set plane_x = 100 -%}
          {%- else -%}
            {%- set plane_x = 2 -%}
          {%- endif -%}

          {%- if route_state == 'Arrived' -%}
            {%- set plane_transform = "translate(-100%, -50%)" -%}
          {%- else -%}
            {%- set plane_transform = "translate(-50%, -50%)" -%}
          {%- endif -%}

          {%- set plane_w_px = 22 -%}
          {%- set gap_px = 3 -%}
          {%- set sched_extra_px = 7 -%}
          {%- set arrived_extra_px = 6 -%}
          {%- set base_cut = (plane_w_px / 2) + gap_px -%}
          {%- if route_state == 'Scheduled' -%}
            {%- set cut_px = base_cut + sched_extra_px -%}
          {%- elif route_state == 'Arrived' -%}
            {%- set cut_px = base_cut + arrived_extra_px -%}
          {%- else -%}
            {%- set cut_px = base_cut -%}
          {%- endif -%}

          {%- if in_flight -%}
            {%- set left_width = "calc(" ~ plane_x ~ "% - " ~ cut_px ~ "px)" -%}
            {%- set right_left = "calc(" ~ plane_x ~ "% + " ~ cut_px ~ "px)" -%}
            {%- set right_width = "calc(100% - " ~ plane_x ~ "% - " ~ cut_px ~ "px)" -%}
          {%- elif route_state == 'Arrived' -%}
            {%- set left_width = "calc(100% - " ~ cut_px ~ "px)" -%}
            {%- set right_left = "100%" -%}
            {%- set right_width = "0%" -%}
          {%- else -%}
            {%- set left_width = "0%" -%}
            {%- set right_left = "calc(0% + " ~ cut_px ~ "px)" -%}
            {%- set right_width = "calc(100% - " ~ cut_px ~ "px)" -%}
          {%- endif -%}

          {%- set remaining_label = None -%}
          {%- if state == 'En Route' and arr_dt -%}
            {%- set rem_sec = (as_timestamp(arr_dt) - as_timestamp(now_dt)) | round(0) -%}
            {%- if rem_sec < 0 %}{% set rem_sec = 0 %}{% endif -%}
            {%- set rem_min = (rem_sec / 60) | round(0) -%}
            {%- set rem_h = (rem_min // 60) | int -%}
            {%- set rem_m = (rem_min % 60) | int -%}
            {%- if rem_h > 0 -%}
              {%- set remaining_label = rem_h ~ "h " ~ rem_m ~ "m" -%}
            {%- else -%}
              {%- set remaining_label = rem_m ~ "m" -%}
            {%- endif -%}
          {%- endif -%}

          {%- set updated = f.status_updated_at and as_datetime(f.status_updated_at) -%}
          {%- set updated_ago = updated and ((as_timestamp(now()) - as_timestamp(updated)) / 60) | round(0) -%}
          {%- set source = (f.status and f.status.provider) or '-' -%}

          {%- set status_error = f.status.error if f.status is defined else None -%}
          {%- set status_error_msg = f.status.error_message if f.status is defined else None -%}
          {%- set show_error = status_error or status_error_msg -%}

          {%- set dep_label_line = dep_label ~ " - " ~ dep_date -%}
          {%- set arr_label_line = arr_label ~ " - " ~ arr_date -%}
          {%- set airline_logo = f.airline_logo_url or ("https://pics.avs.io/64/64/" ~ (f.airline_code | default('') | upper) ~ ".png") -%}
          {%- set airline_name = f.airline_name or '' -%}

          {%- set diverted_air = f.get('diverted_to_airport') or {} -%}
          {%- set diverted_iata = (f.get('diverted_to_iata') or diverted_air.get('iata') or '') -%}
          {%- set diverted_code = diverted_iata and diverted_iata | upper -%}
          {%- set diverted_label_raw = diverted_air.get('city') or diverted_air.get('name') or diverted_code -%}
          {%- set diverted_label = diverted_label_raw | title -%}
          {%- set has_diverted = (state == 'Diverted') and diverted_code -%}

          {%- set route_arr_code = diverted_code if has_diverted else arr_code -%}
          {%- set arr_label_line = (("<span class='line-through opacity-60'>" ~ arr_label ~ " - " ~ arr_date ~ "</span> &rarr; " ~ diverted_label ~ " - " ~ arr_date) if has_diverted else (arr_label ~ " - " ~ arr_date)) -%}

          {
            "type": "custom:tailwindcss-template-card",
            "content": "<div class='rounded-2xl bg-[rgba(255,255,255,0.04)] p-4 space-y-3'>\
            <div class='flex items-center gap-3'>\
              <img src='{{ airline_logo }}' class='h-12 w-12 object-contain rounded bg-white/90 p-1 ring-1 ring-white/30' />\
              <div class='flex-1'>\
                <div class='text-lg'>{{ f.airline_code }} {{ f.flight_number }} - {{ dep_date }}</div>\
                <div class='text-sm opacity-80'>{{ airline_name }}{% if f.aircraft_type %} - {{ f.aircraft_type }}{% endif %}{% if f.duration_minutes is not none %} - {{ (f.duration_minutes or 0) // 60 }}h {{ (f.duration_minutes or 0) % 60 }}m{% endif %}</div>\
              </div>\
              <span class='text-xs px-2 py-1 rounded-full {{ badge }} text-center'>\
                <div class='leading-tight'>{{ state }}</div>\
                {% if remaining_label %}<div class='leading-tight opacity-90'>{{ remaining_label }} left</div>{% endif %}\
              </span>\
            </div>\
            <div class='flex items-center gap-2 flex-nowrap'>\
              <div class='text-xl sm:text-2xl font-semibold shrink-0 whitespace-nowrap'>{{ dep_code }}</div>\
              <div class='flex-1 min-w-0'>\
                <div class='relative w-full h-0.5'>\
                  <div class='absolute left-0 top-0 h-0.5 rounded {{ route_bg }}' style='width: {{ left_width }};'></div>\
                  <div class='absolute top-0 h-0.5 rounded bg-gray-300/60' style='left: {{ right_left }}; width: {{ right_width }};'></div>\
                  <div class='absolute {{ route_color }}' style='left: {{ plane_x }}%; top: 50%; transform: {{ plane_transform }}; font-size:18px; font-weight:700;'>&#9992;</div>\
                </div>\
              </div>\
              <div class='text-xl sm:text-2xl font-semibold shrink-0 whitespace-nowrap'>{{ route_arr_code }}</div>\
            </div>\
            <div class='grid grid-cols-2 gap-x-4 gap-y-1 text-sm'>\
              <div class='opacity-80'>{{ dep_label_line }}</div><div class='opacity-80'>{{ arr_label_line }}</div>\
              <div class='opacity-70'>{{ 'Departed' if dep_act else 'Scheduled Departure' }}</div><div class='opacity-70'>{{ 'Estimated Arrival' if arr_est_or_act else 'Scheduled Arrival' }}</div>\
              <div class='text-2xl font-semibold {{ time_color }}'>{% if dep_changed %}{{ dep_est_or_act }}{% else %}{{ dep_est_or_act or dep_sched or '-' }}{% endif %}<span class='text-xs opacity-70 ml-1'>{{ dep_tz }}</span></div>\
              <div class='text-2xl font-semibold {{ time_color }}'>{% if arr_changed %}{{ arr_est_or_act }}{% else %}{{ arr_est_or_act or arr_sched or '-' }}{% endif %}<span class='text-xs opacity-70 ml-1'>{{ arr_tz }}</span></div>\
              {% if show_strike_row %}\
              <div class='line-through opacity-50 {% if not dep_changed %}opacity-0{% endif %}'>{% if dep_changed %}{{ dep_sched }}{% else %}&nbsp;{% endif %}</div>\
              <div class='line-through opacity-50 {% if not arr_changed %}opacity-0{% endif %}'>{% if arr_changed %}{{ arr_sched }}{% else %}&nbsp;{% endif %}</div>\
              {% endif %}\
              {% if show_viewer_row %}\
              <div class='opacity-70 {% if not show_dep_viewer %}opacity-0{% endif %}'>{% if show_dep_viewer %}{{ dep_viewer }} {{ viewer_tz }}{% else %}&nbsp;{% endif %}</div>\
              <div class='opacity-70 {% if not show_arr_viewer %}opacity-0{% endif %}'>{% if show_arr_viewer %}{{ arr_viewer }} {{ viewer_tz }}{% else %}&nbsp;{% endif %}</div>\
              {% endif %}\
              {% if show_term_gate_row %}\
              <div class='opacity-70'>{{ dep_term_gate }}</div>\
              <div class='opacity-70'>{{ arr_term_gate }}</div>\
              {% endif %}\
            </div>\
            {% if pax %}<div class='text-sm opacity-80'>Travellers: {{ pax }}</div>{% endif %}\
            {% if show_error %}\
            <div class='text-[11px] text-amber-200 bg-amber-900/40 px-2 py-1 rounded-md'>\
              Provider issue: {{ status_error_msg or status_error }}\
            </div>\
            {% endif %}\
            <div class='text-xs opacity-60'>Updated {{ updated_ago or '-' }} min ago - Source: {{ source }}</div>\
          </div>"
          }{{ "," if not loop.last else "" }}
        {%- endfor -%}
        ]
